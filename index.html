<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
  <title>GovernMental</title>
  <!-- Bootstrap -->
  <link href="static/css/bootstrapDarkly.min.css" rel="stylesheet">
  <link href="static/css/site.css" rel="stylesheet">
  <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body>
  <nav class="navbar navbar-default navbar-fixed-top">
    <div class="container-fluid">
      <!-- Brand and toggle get grouped for better mobile display -->
      <div class="navbar-header">
        <button type="button" class="navbar-toggle collapsed">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand">
          GovernMental
        </a>
      </div>
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse">
        <ul class="nav navbar-nav">
          <li><a href="https://sepolia.etherscan.io/address/0x0380eae743058013864db2f2c6ba83610a8b0bef#code" target="_blank"><strong>Contract on etherchain.org</strong></a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
          <li><a><strong>Balance: <span id="balance">-</span> Ether</strong></a></li>
          <li><a><strong>Address: <span id="address">-</span></strong></a></li>
        </ul>
      </div><!-- /.navbar-collapse -->
    </div><!-- /.container-fluid -->
  </nav>
  <div class="container">
    <div class="row">
      <div class="clearfix text-center">
        <div style="font-size: 4em;">
          Jackpot:
        </div>
        <div style="font-size: 10em;">
          <span id="jackpot">-</span> ETH
        </div>
        <div style="font-size: 4em;">
          Payed out to <a href="" id="winner" target="_blank"></a> in:
        </div>
        <div style="font-size: 8em;">
          <span id="countdown">-</span>
        </div>
      </div>
      <div class="alert alert-success">
        To play GovernMental, make sure you are synchronized to the best block and start your geth-node with <i>geth --rpc --rpccorsdomain "http://governmental.github.io"</i><br>
        Play by sending Ether directly to the contract <i>0x0380EAE743058013864Db2F2c6Ba83610a8b0BEF</i> from any account you own. Winnings are sent back to the same account.
      </div>
      <div class="col-md-4">
        <div class="panel panel-primary">
          <!-- Default panel contents -->
          <div class="panel-heading">
            Last creditors
            <span class="pull-right">Total debts: <span id="totalDebts">-</span> ETH</span>
          </div>
          <table class="table table-striped">
            <thead>
              <th>#</th>
              <th>Address</th>
              <th>Ether</th>
            </thead>
            <tbody id="investments"></tbody>
          </table>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel panel-success">
          <!-- Default panel contents -->
          <div class="panel-heading">
            Last payouts
            <span class="pull-right">Total payouts: <span id="totalPayouts">-</span> ETH</span>
          </div>
          <table class="table table-striped">
            <thead>
              <th>#</th>
              <th>Address</th>
              <th>Ether</th>
            </thead>
            <tbody id="payouts"></tbody>
          </table>
        </div>
      </div>
      <div class="col-md-4">
        <div class="panel panel-info">
          <!-- Default panel contents -->
          <div class="panel-heading">
            Next payouts
          </div>
          <table class="table table-striped">
            <thead>
              <th>#</th>
              <th>Address</th>
              <th>Ether</th>
            </thead>
            <tbody id="nextPayouts"></tbody>
          </table>
        </div>
      </div>
      <div class="clearfix"></div>
      <div class="panel panel-default">
        <div class="panel-heading">
          Invest
        </div>
        <div class="panel-body">
          <div class="form-group col-md-6">
            <label for="amount">Ether</label>
            <input type="number" step="any" class="form-control" id="amount" placeholder="Enter amount"><br>
            <button type="button" class="btn btn-primary" id="invest">Invest</button>
          </div>
          <div class="form-group col-md-6 hide">
            <label for="buddy">Buddy</label>
            <select id="buddy" class="form-control">
              <option value="0">Select buddy</option>
            </select>
          </div>
          <div class="form-group col-md-6">
            <h2>What is this?</h2>
            <p>
              This is an educational game that simulates the finances of a government - in other words: It's a Ponzi scheme.
            </p>
          </div>
          <div class="clearfix"></div>
          <div class="form-group col-md-6">
            <h4>Rule 1</h4>
            You can lend the government money - they promise to pay it back +10% interest. The minimum contribution is 1 Ether.
            <h4>Rule 2</h4>
            If the government does not receive new money for 12 hours, the system breaks down. The latest creditor saw the crash coming and receives the jackpot. All others will lose their claims.
          </div>
          <div class="form-group col-md-6">
            <h4>Rule 3</h4>
            All incoming money is used in the following way: 5% goes into the "jackpot" (capped at 10k Ether), 5% goes to the corrupt elite that runs the government, 90% are used to pay out creditors in order of their date of credit. When the jackpot is full, 95% goes toward the payout of creditors.
            <h4>Rule 4</h4>
            Creditors can share an affiliate link. Money deposited this way is distributed as follows: 5% goes to the linker directly, 5% to the corrupt elite, 5% into the jackpot (until full). The rest is used for payouts.
          </div>
          <div class="form-group col-md-12">
            <h4>Read more about GovernMental here:</h4>
            <ul>
              <li><a href="https://twitter.com/g0vernmental" target="_blank">Twitter.com</a></li>
              <li><a href="https://forum.ethereum.org/discussion/5201/new-dapp-government-simulation-game-theoretic-variation-of-simple-ponzi-1000eth-jackpot#latest" target="_blank">forum.ethereum.org</a></li>
              <li><a href="https://bitcointalk.org/index.php?topic=1424324.0" target="_blank">Bitcointalk.org</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading clearfix">
          Connection
          <a class="btn-sm pull-right btn-default" role="button" data-toggle="collapse" href="#collapse" aria-expanded="false" aria-controls="collapse">
            show
          </a>
        </div>
        <div class="panel-body collapse clearfix" id="collapse">
          <div class="form-group col-md-6">
            <label for="ethereum-node">Node</label>
            <input type="text" class="form-control" id="ethereum-node" placeholder="Node" value="http://localhost:8545">
          </div>
          <div class="form-group col-md-6">
            <label for="contract-address">Contract-address</label>
            <input type="text" class="form-control" id="contract-address" placeholder="Contract-address" value="0x0380EAE743058013864Db2F2c6Ba83610a8b0BEF">
          </div>
          <div class="form-group col-md-12">
            <button type="button" class="btn btn-default" id="connect">Connect</button>
            <button type="button" class="btn btn-primary" id="connect-wallet-btn">Connect Wallet</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Modal -->
  <div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
          <h4 class="modal-title" id="modalLabel">Modal Title</h4>
        </div>
        <div class="modal-body">
          Modal Body
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>
  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="static/js/jquery-3.6.0.min.js"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="static/js/bootstrap.min.js"></script>
  <!-- Other dependencies -->
  <script src="static/js/countdown.min.js"></script>
  <script src="static/js/jquery.countTo.min.js"></script>
  <script src="static/js/web3.min.js"></script>
  <script src="static/js/bignumber.min.js"></script>
  <!-- Application JavaScript -->
  <script>
    $(document).ready(function () {
      if (typeof window.ethereum === 'undefined') {
        window.web3 = new Web3();
      }

      /* state */
      var updateInterval;
      var coinbase;
      var jackpot;
      var countdown;

      /* constants */
      var TWELVE_HOURS = 43200;
      var DEFAULT_GAS = 3000000;

      // Function to connect to the blockchain using Infura
      function connectToInfura() {
        var infuraUrl = "https://sepolia.infura.io/v3/4c665d4153cd460098da8b8b5695739f"; // Replace with your Infura project ID
        var web3 = new Web3(new Web3.providers.HttpProvider(infuraUrl));

        $.getJSON("static/js/abi.json", function (abi) {
          var contractAddress = "0x0380EAE743058013864Db2F2c6Ba83610a8b0BEF"; // Replace with your contract address
          window.ponziContract = new web3.eth.Contract(abi, contractAddress);

          clearInterval(updateInterval);
          updateInterval = setInterval(update, 10000); // every 10s
          update();
        });
      }

      // Get the "Connect Wallet" button element
      var connectWalletBtn = document.getElementById("connect-wallet-btn");

      // Attach the click event listener to the button
      connectWalletBtn.addEventListener("click", function () {
        if (typeof window.ethereum !== 'undefined') {
          window.web3 = new Web3(window.ethereum);
          window.ethereum.request({ method: 'eth_requestAccounts' }).then(function (accounts) {
            openModal('Wallet Connected', 'Your Ethereum wallet is now connected.<br><br>Address: ' + accounts[0]);
            connectToInfura();
          }).catch(function (error) {
            openModal('Error', 'An error occurred while connecting to your Ethereum wallet.<br><br>Error:<p>' + error + '</p>');
            console.error(error);
          });
        } else {
          openModal('Error', 'No Ethereum wallet found. Please install MetaMask or another Ethereum wallet extension in your browser.');
        }
      });

      function openModal(title, body) {
        $('.modal-title').text(title);
        $('.modal-body').html(body);
        $('#modal').modal();
      }

      function handleError(error) {
        clearInterval(updateInterval);
        openModal('Error', 'An error occurred, please reload.<br><br>Error:<p>' + error + '</p>');
        console.error(error);
      }

      function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
          sURLVariables = sPageURL.split('&'),
          sParameterName,
          i;

        for (i = 0; i < sURLVariables.length; i++) {
          sParameterName = sURLVariables[i].split('=');
          if (sParameterName[0] === sParam) {
            return sParameterName[1] === undefined ? true : sParameterName[1].replace(/\/$/, "");
          }
        }
      }

      function update() {
        // update coinbase and balance
        window.ethereum.request({ method: 'eth_requestAccounts' }).then(function (accounts) {
          coinbase = accounts[0];
          $("#address").text(coinbase);
          web3.eth.getBalance(coinbase, function (error, result) {
            if (error) {
              handleError(error);
            }
            else {
              $("#balance").text(web3.utils.fromWei(result, "Ether"));
            }
          });
        }).catch(function (error) {
          handleError(error);
        });

        // update jackpot
        ponziContract.methods.profitFromCrash().call(function (error, result) {
          if (error) {
            handleError(error);
          }
          else {
            var oldJackpot = jackpot;
            jackpot = parseInt(web3.utils.fromWei(result, "Ether"));
            if (oldJackpot != jackpot) {
              $('#jackpot').countTo({
                from: oldJackpot,
                to: jackpot,
                speed: 1000,
                refreshInterval: 50,
                formatter: function (value) {
                  return Math.ceil(value).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                }
              });
            }
          }
        });

        // update countdown
        ponziContract.methods.lastTimeOfNewCredit().call(function (error, result) {
          if (error) {
            handleError(error);
          }
          else {
            var oldCountdown = countdown;
            countdown = parseInt(new BigNumber(result));
            if (oldCountdown != countdown) {
              $("#countdown").countdown(new Date((countdown + TWELVE_HOURS) * 1000), function (event) {
                $(this).text(
                  event.strftime('%H:%M:%S')
                );
              });
            }
          }
        });

        // update total payouts
        ponziContract.methods.totalPayedOut().call(function (error, result) {
          if (error) {
            handleError(error);
          }
          else {
            $("#totalPayouts").text(web3.utils.fromWei(result, "Ether"));
          }
        });

        // update total debts
        ponziContract.methods.totalDebt().call(function (error, result) {
          if (error) {
            handleError(error);
          }
          else {
            $("#totalDebts").text(web3.utils.fromWei(result, "Ether"));
          }
        });

        // update last investments and payouts
        ponziContract.methods.getCreditorAddresses().call(function (error, newCreditorAddresses) {
          if (error) {
            handleError(error);
          }
          else {
            ponziContract.methods.getCreditorAmounts().call(function (error, newCreditorAmounts) {
              if (error) {
                handleError(error);
              }
              else {
                ponziContract.methods.lastCreditorPayedOut().call(function (error, newLastCreditorPayedOut) {
                  if (error) {
                    handleError(error);
                  }
                  else {
                    if (newCreditorAddresses.length > 0) {
                      var winnerAddress = newCreditorAddresses[newCreditorAddresses.length - 1];
                      $("#winner").text(winnerAddress.substring(0, 7)).attr("href", "https://live.ether.camp/account/" + winnerAddress);
                    }

                    var investments = $("#investments");
                    investments.html("");
                    for (var i = newCreditorAddresses.length - 1; i > (newCreditorAddresses.length - 4) && i >= 0; i--) {
                      var investorRow = $("<tr></tr>");
                      investorRow.append($("<td>" + (i + 1) + "</td>"));
                      investorRow.append($('<td><a href="' + "https://live.ether.camp/account/" + newCreditorAddresses[i] + '" target="_blank">' + newCreditorAddresses[i].substr(0, 22) + "</a></td>"));
                      investorRow.append($("<td>" + web3.utils.fromWei(newCreditorAmounts[i], "Ether") + "</td>"));
                      investments.append(investorRow);
                    }

                    var payouts = $("#payouts");
                    payouts.html("");
                    for (i = parseInt(newLastCreditorPayedOut) - 1; i > (newLastCreditorPayedOut - 4) && i >= 0; i--) {
                      var payoutRow = $("<tr></tr>");
                      payoutRow.append($("<td>" + (i + 1) + "</td>"));
                      payoutRow.append($('<td><a href="' + "https://live.ether.camp/account/" + newCreditorAddresses[i] + '" target="_blank">' + newCreditorAddresses[i].substr(0, 22) + "</a></td>"));
                      payoutRow.append($("<td>" + web3.utils.fromWei(newCreditorAmounts[i], "Ether") + "</td>"));
                      payouts.append(payoutRow);
                    }

                    var nextPayouts = $("#nextPayouts");
                    nextPayouts.html("");
                    for (i = parseInt(newLastCreditorPayedOut); i < newCreditorAddresses.length && i < (parseInt(newLastCreditorPayedOut) + 3); i++) {
                      var nextPayoutRow = $("<tr></tr>");
                      nextPayoutRow.append($("<td>" + (i + 1) + "</td>"));
                      nextPayoutRow.append($('<td><a href="' + "https://live.ether.camp/account/" + newCreditorAddresses[i] + '" target="_blank">' + newCreditorAddresses[i].substr(0, 22) + "</a></td>"));
                      nextPayoutRow.append($("<td>" + web3.utils.fromWei(newCreditorAmounts[i], "Ether") + "</td>"));
                      nextPayouts.append(nextPayoutRow);
                    }

                    var buddies = $("#buddy");
                    var buddySelection = $("#buddy").val() != "0" ? $("#buddy").val() : ($.inArray(getUrlParameter('buddy'), newCreditorAddresses) > -1 ? getUrlParameter('buddy') : "0");
                    buddies.html("");
                    buddies.append($('<option>', { value: 0 }).text("Select buddy"));
                    var uniqueAddresses = jQuery.unique(newCreditorAddresses);
                    for (i = 0; i < uniqueAddresses.length; i++) {
                      buddies.append($('<option>', { value: uniqueAddresses }).text(uniqueAddresses));
                    }
                    buddies.val(buddySelection);
                  }
                });
              }
            });
          }
        });
      }

      $("#connect").on("click", function () {
        openModal('Connecting', 'Establishing connection. Please close window.');
        connectToInfura();
      });

      $("#invest").on("click", function () {
        web3.eth.getBalance("0x0380EAE743058013864Db2F2c6Ba83610a8b0BEF", function (error, result) {
          if (error) {
            handleError(error);
          }
          else {
            var value = $("#amount").val();
            if (!isNaN(value) && parseFloat(value) >= 1) {
              ponziContract.methods.lendGovernmentMoney($("#buddy").val())
                .send({ from: coinbase, value: web3.utils.toWei(value, "Ether"), gas: DEFAULT_GAS, gasPrice: web3.eth.gasPrice })
                .then(function (receipt) {
                  var txLink = "https://live.ether.camp/transaction/" + receipt.transactionHash;
                  var buddyLink = window.location.origin + "/?buddy=" + coinbase;
                  openModal('Investment', 'Thank you for your investment!<br><br>Your transaction:<br><a target="_blank" href="' + txLink + '">' + txLink.substring(0, 64) + '</a><br><br>Spread the word and earn Ether:<br><a target="_blank" href="' + buddyLink + '">' + buddyLink + '</a>');
                  $("#amount").val("");
                })
                .catch(function (error) {
                  handleError(error);
                });
            }
            else {
              openModal('Wrong value', 'You have to invest at least 1 Ether.');
            }
          }
        });
      });

      connectToInfura();
    });
  </script>
</body>
</html>
